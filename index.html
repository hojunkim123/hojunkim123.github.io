<!DOCTYPE html>
<html lang="ko">
<head>
  <base target="_top">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì§„í•´ë™ì¼ê³ ë“±í•™êµ ìˆ˜í•™ì—¬í–‰ ì¢…í•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
    .h-screen-safe { height: 100vh; height: -webkit-fill-available; }
  </style>
</head>

<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, StrictMode } = React;

    // =========================
    // 1) MOCK DATA (ë¡œì»¬ HTML ì‹¤í–‰ìš©)
    // =========================
    const MOCK_SERVER_DATA = {
      students: [
        '1ë°˜ 01ë²ˆ ê°•ì§€ë¯¼', '1ë°˜ 02ë²ˆ ê¹€ì„œì•„', '1ë°˜ 03ë²ˆ ë°•ì´ì¤€', '1ë°˜ 04ë²ˆ ì´ì‹œìš°', '1ë°˜ 05ë²ˆ ì •í•˜ìœ¤', '1ë°˜ 06ë²ˆ ì˜¤ì§€ì•ˆ',
        '2ë°˜ 01ë²ˆ ìµœìœ ì°¬', '2ë°˜ 02ë²ˆ ìœ¤ì•„ë¦°', '2ë°˜ 03ë²ˆ í•œì¬ì´', '2ë°˜ 04ë²ˆ ì‹ ì€ìš°', '2ë°˜ 05ë²ˆ ì†¡ì§€í˜¸', '2ë°˜ 06ë²ˆ ë°°ì„œì•„',
        '3ë°˜ 01ë²ˆ ì˜¤ì„œì¤€', '3ë°˜ 02ë²ˆ ì„ë„í•˜', '3ë°˜ 03ë²ˆ í™©ë¦¬ì•ˆ', '3ë°˜ 04ë²ˆ ë¬¸ì§€ì•„', '3ë°˜ 05ë²ˆ ì¥ì„œìš°', '3ë°˜ 06ë²ˆ ê¹€ì´ì„œ',
        '4ë°˜ 01ë²ˆ ê³ ì€í˜¸', '4ë°˜ 02ë²ˆ ê³½ì‹œì•ˆ', '4ë°˜ 03ë²ˆ ê¶Œì´ì•ˆ', '4ë°˜ 04ë²ˆ ë°±ë¡œìš´', '4ë°˜ 05ë²ˆ í—ˆìœ ì£¼', '4ë°˜ 06ë²ˆ ìœ ë‚˜ë¹„'
      ],
      teachers: [
        { name: "ê¹€ë¯¼ì¤€(ì´ê´„)", contact: "010-1234-5678" },
        { name: "ì´ì„œì—°(1í˜¸ì°¨)", contact: "010-2345-6789" },
        { name: "ë°•ë„ìœ¤(2í˜¸ì°¨)", contact: "010-3456-7890" },
        { name: "ìµœì•„ì¸(3í˜¸ì°¨)", contact: "010-4567-8901" }
      ],
      busData: {
        '1': { '1': '1ë°˜ 01ë²ˆ ê°•ì§€ë¯¼', '5': '2ë°˜ 01ë²ˆ ìµœìœ ì°¬' },
        '2': { '1': '1ë°˜ 02ë²ˆ ê¹€ì„œì•„' },
        '3': {}
      },
      activities: {
        day1_kbs: ['1ë°˜ 01ë²ˆ ê°•ì§€ë¯¼', '2ë°˜ 01ë²ˆ ìµœìœ ì°¬', '3ë°˜ 01ë²ˆ ì˜¤ì„œì¤€', '4ë°˜ 01ë²ˆ ê³ ì€í˜¸'],
        day1_museum: ['1ë°˜ 02ë²ˆ ê¹€ì„œì•„', '2ë°˜ 02ë²ˆ ìœ¤ì•„ë¦°', '3ë°˜ 02ë²ˆ ì„ë„í•˜', '4ë°˜ 02ë²ˆ ê³½ì‹œì•ˆ'],
        day2_sky: ['1ë°˜ 03ë²ˆ ë°•ì´ì¤€', '1ë°˜ 04ë²ˆ ì´ì‹œìš°', '3ë°˜ 05ë²ˆ ì¥ì„œìš°', '4ë°˜ 04ë²ˆ ë°±ë¡œìš´'],
      },
      roomData: [
        ['101', '2ì¸ì‹¤', '1ë°˜ 01ë²ˆ ê°•ì§€ë¯¼'], ['101', '2ì¸ì‹¤', '1ë°˜ 02ë²ˆ ê¹€ì„œì•„'],
        ['102', '2ì¸ì‹¤', '1ë°˜ 03ë²ˆ ë°•ì´ì¤€'], ['102', '2ì¸ì‹¤', '1ë°˜ 04ë²ˆ ì´ì‹œìš°'],
        ['201', '3ì¸ì‹¤', '2ë°˜ 01ë²ˆ ìµœìœ ì°¬'], ['201', '3ì¸ì‹¤', '2ë°˜ 02ë²ˆ ìœ¤ì•„ë¦°'], ['201', '3ì¸ì‹¤', '2ì¸ì‹¤', '2ë°˜ 03ë²ˆ í•œì¬ì´'].slice(0,3),
        ['202', '3ì¸ì‹¤', 'ê¹€ë¯¼ì¤€(ì´ê´„)'], ['202', '3ì¸ì‹¤', 'ì´ì„œì—°(1í˜¸ì°¨)'],
      ],
      announcements: [
        { timestamp: '2026. 01. 21. ì˜¤ì „ 9:05', text: '1í˜¸ì°¨, 2í˜¸ì°¨ í•™ìƒë“¤ì€ 10ë¶„ ë’¤ ì¶œë°œí•©ë‹ˆë‹¤. ëŠ¦ì§€ ì•Šê²Œ íƒ‘ìŠ¹í•´ì£¼ì„¸ìš”.' },
        { timestamp: '2026. 01. 22. ì˜¤ì „ 8:30', text: 'ëª¨ë“  í•™ìƒì€ 9ì‹œê¹Œì§€ ì§€ì •ëœ ë²„ìŠ¤ì— íƒ‘ìŠ¹ ì™„ë£Œí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.' },
      ],
      missions: [
        ['1ì¼ì°¨', 'KBS ë°©ì†¡êµ­', 'ë‰´ìŠ¤ ì•µì»¤ ë°ìŠ¤í¬ì—ì„œ ì‚¬ì§„ ì°ê¸°'],
        ['1ì¼ì°¨', 'êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€', 'ê°€ì¥ ë§ˆìŒì— ë“œëŠ” ìœ ë¬¼ê³¼ í•¨ê»˜ ì¸ì¦ìƒ· ë‚¨ê¸°ê¸°'],
        ['2ì¼ì°¨', 'ë¡¯ë°ì›”ë“œ', 'íŒ€ì› ì „ì²´ê°€ ë¨¸ë¦¬ë í•˜ê³  ë‹¨ì²´ ì‚¬ì§„ ì°ê¸°'],
        ['3ì¼ì°¨', 'ê²½ë³µê¶', 'ì™¸êµ­ì¸ ê´€ê´‘ê°ì—ê²Œ ë¨¼ì € ë‹¤ê°€ê°€ì„œ ì‚¬ì§„ ì°ì–´ì£¼ê¸°'],
      ],
      mealMenus: [
        ['day1_lunch', '1ì¼ì°¨ ì ì‹¬', 'ë¶ˆê³ ê¸°ë°±ë°˜', 'ë¹„ë¹”ë°¥'],
        ['day1_dinner', '1ì¼ì°¨ ì €ë…', 'Aì½”ìŠ¤(ì–‘ì‹)', 'Bì½”ìŠ¤(í•œì‹)', 'Cì½”ìŠ¤(ììœ¨)'],
        ['day2_lunch', '2ì¼ì°¨ ì ì‹¬ (ë¡¯ë°ì›”ë“œ)', 'ììœ ì„ íƒ'],
        ['day3_lunch', '3ì¼ì°¨ ì ì‹¬', 'ë©”ë‰´1', 'ë©”ë‰´2'],
      ],
      mealChoices: {
        'day1_lunch': { '1ë°˜ 01ë²ˆ ê°•ì§€ë¯¼': 'ë¶ˆê³ ê¸°ë°±ë°˜', '1ë°˜ 02ë²ˆ ê¹€ì„œì•„': 'ë¹„ë¹”ë°¥' },
        'day1_dinner': { '1ë°˜ 01ë²ˆ ê°•ì§€ë¯¼': 'Aì½”ìŠ¤(ì–‘ì‹)' }
      }
    };

    let mockDataStore = JSON.parse(JSON.stringify(MOCK_SERVER_DATA));

    // =========================
    // 2) Google Script ì—°ê²° ê°ì§€
    // =========================
    const isDevelopment = !(window.google && window.google.script && window.google.script.run);

    if (isDevelopment) {
      console.log('%c[DEV MODE] Using mock data. (ë¡œì»¬ HTML ì‹¤í–‰)', 'color: orange; font-weight: bold;');
    }

    // =========================
    // 3) runAsync (DEV: mock / PROD: google.script.run)
    // =========================
    const runAsync = (functionName, ...args) => {
      if (isDevelopment) {
        return new Promise((resolve) => {
          setTimeout(() => {
            console.log(`[DEV MODE] Mock call: ${functionName}`, args);
            try {
              let result;
              switch (functionName) {
                case 'getServerData':
                  result = JSON.parse(JSON.stringify(mockDataStore));
                  break;

                case 'updateBusSeat': {
                  const [bus, seat, name] = args;
                  if (!mockDataStore.busData[bus]) mockDataStore.busData[bus] = {};
                  Object.keys(mockDataStore.busData).forEach(busKey => {
                    Object.keys(mockDataStore.busData[busKey]).forEach(seatKey => {
                      if (mockDataStore.busData[busKey][seatKey] === name) {
                        delete mockDataStore.busData[busKey][seatKey];
                      }
                    });
                  });
                  if (name) mockDataStore.busData[bus][seat] = name;
                  else delete mockDataStore.busData[bus][seat];

                  result = JSON.parse(JSON.stringify(mockDataStore));
                  break;
                }

                case 'resetBus': {
                  const [busToReset] = args;
                  if (mockDataStore.busData[busToReset]) mockDataStore.busData[busToReset] = {};
                  result = JSON.parse(JSON.stringify(mockDataStore));
                  break;
                }

                case 'addAnnouncement': {
                  const [text] = args;
                  const newAnnouncement = {
                    timestamp: new Date().toLocaleString('ko-KR', {
                      hour12: false,
                      year: 'numeric', month: '2-digit', day: '2-digit',
                      hour: '2-digit', minute: '2-digit'
                    }),
                    text,
                  };
                  mockDataStore.announcements.unshift(newAnnouncement);
                  result = [...mockDataStore.announcements];
                  break;
                }

                case 'saveAllMealChoices': {
                  const [studentName, choices] = args;
                  Object.keys(mockDataStore.mealChoices).forEach(mealId => {
                    if (mockDataStore.mealChoices[mealId][studentName]) {
                      delete mockDataStore.mealChoices[mealId][studentName];
                    }
                  });
                  Object.keys(choices).forEach(mealId => {
                    if (!mockDataStore.mealChoices[mealId]) mockDataStore.mealChoices[mealId] = {};
                    mockDataStore.mealChoices[mealId][studentName] = choices[mealId];
                  });
                  result = JSON.parse(JSON.stringify(mockDataStore));
                  break;
                }

                case 'updateStudentActivity': {
                  const [studentName, newActivityKey] = args;
                  Object.keys(mockDataStore.activities).forEach(k => {
                    mockDataStore.activities[k] = (mockDataStore.activities[k] || []).filter(n => n !== studentName);
                  });
                  if (newActivityKey && newActivityKey !== 'none') {
                    if (!mockDataStore.activities[newActivityKey]) mockDataStore.activities[newActivityKey] = [];
                    if (!mockDataStore.activities[newActivityKey].includes(studentName)) {
                      mockDataStore.activities[newActivityKey].push(studentName);
                    }
                  }
                  result = JSON.parse(JSON.stringify(mockDataStore));
                  break;
                }

                // âœ… ìˆ™ì†Œ ë°°ì •: íŠ¹ì • ì‚¬ëŒì„ íŠ¹ì • ë°©ì— ë°°ì •(ê¸°ì¡´ ë°°ì •ì€ ì œê±°)
                case 'setRoomAssignment': {
                  const [personName, roomNum, roomType] = args;

                  // 1) ê¸°ì¡´ ë°°ì • ì œê±°
                  mockDataStore.roomData = (mockDataStore.roomData || []).filter(row => row[2] !== personName);

                  // 2) ìƒˆ ë°°ì • ì¶”ê°€ (roomNum, roomType, personName)
                  if (personName && roomNum && roomType) {
                    mockDataStore.roomData.push([String(roomNum), String(roomType), String(personName)]);
                  }

                  result = JSON.parse(JSON.stringify(mockDataStore));
                  break;
                }

                // âœ… ìˆ™ì†Œ ë°°ì • ì‚­ì œ
                case 'removeRoomAssignment': {
                  const [personName] = args;
                  mockDataStore.roomData = (mockDataStore.roomData || []).filter(row => row[2] !== personName);
                  result = JSON.parse(JSON.stringify(mockDataStore));
                  break;
                }

                // âœ… ë°© íƒ€ì… ë³€ê²½(í•´ë‹¹ ë°© ì „ì²´)
                case 'setRoomType': {
                  const [roomNum, roomType] = args;
                  mockDataStore.roomData = (mockDataStore.roomData || []).map(row => {
                    if (String(row[0]) === String(roomNum)) return [String(roomNum), String(roomType), row[2]];
                    return row;
                  });
                  result = JSON.parse(JSON.stringify(mockDataStore));
                  break;
                }

                case 'saveSubscription':
                  console.log('Saved subscription:', args[0]);
                  result = { success: true };
                  break;

                default:
                  throw new Error(`Mock for ${functionName} not implemented.`);
              }
              resolve(result);
            } catch (e) {
              console.error(`Mock function for ${functionName} failed:`, e);
              resolve({ error: true, message: e.message });
            }
          }, 250);
        });
      }

      // PROD (Apps Script)
      return new Promise((resolve, reject) => {
        window.google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName](...args);
      });
    };

    const googleScript = {
      getServerData: () => runAsync('getServerData'),
      updateBusSeat: (bus, seat, name) => runAsync('updateBusSeat', bus, seat, name),
      resetBus: (bus) => runAsync('resetBus', bus),
      addAnnouncement: (text) => runAsync('addAnnouncement', text),
      saveAllMealChoices: (studentName, choices) => runAsync('saveAllMealChoices', studentName, choices),
      saveSubscription: (subscription) => runAsync('saveSubscription', subscription),

      updateStudentActivity: (studentName, activityKey) => runAsync('updateStudentActivity', studentName, activityKey),

      // âœ… ìˆ™ì†Œ ë°°ì •(êµì‚¬ìš© í¸ì§‘)
      setRoomAssignment: (personName, roomNum, roomType) => runAsync('setRoomAssignment', personName, roomNum, roomType),
      removeRoomAssignment: (personName) => runAsync('removeRoomAssignment', personName),
      setRoomType: (roomNum, roomType) => runAsync('setRoomType', roomNum, roomType),
    };

    // =========================
    // 4) Icons
    // =========================
    const Icon = ({ path, className="w-6 h-6" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
        <path fillRule="evenodd" d={path} clipRule="evenodd" />
      </svg>
    );

    const BusIcon = () => <Icon path="M3 5.25A2.25 2.25 0 015.25 3h13.5A2.25 2.25 0 0121 5.25v13.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75V5.25zM5.25 4.5a.75.75 0 00-.75.75v3a.75.75 0 00.75.75h13.5a.75.75 0 00.75-.75v-3a.75.75 0 00-.75-.75H5.25zM19.5 10.5H4.5v8.25c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75V10.5z" />;
    const ScheduleIcon = () => <Icon path="M12.75 12.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM7.5 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM8.25 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM9.75 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM10.5 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM12 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM12.75 18a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM15 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM15.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM16.5 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM12 2.25A5.25 5.25 0 006.75 7.5v.75H5.25A2.25 2.25 0 003 10.5v8.25c0 1.242 1.008 2.25 2.25 2.25h13.5A2.25 2.25 0 0021 18.75V10.5A2.25 2.25 0 0018.75 8.25h-1.5V7.5A5.25 5.25 0 0012 2.25z" />;
    const MegaphoneIcon = () => <Icon path="M10.5 1.75a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5zM13.5 1.75a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5zM2.25 7.5A.75.75 0 003 8.25v1.5a.75.75 0 001.5 0v-1.5A.75.75 0 003.75 6H2.25a.75.75 0 00-.75.75v10.5c0 .414.336.75.75.75h1.5a.75.75 0 000-1.5H3V8.25A.75.75 0 002.25 7.5zM6 7.5a.75.75 0 00-.75.75v1.5a.75.75 0 001.5 0v-1.5A.75.75 0 006 7.5zM18 7.5a.75.75 0 00-.75.75v1.5a.75.75 0 001.5 0v-1.5A.75.75 0 0018 7.5zM20.25 6h-1.5a.75.75 0 00-.75.75v1.5a.75.75 0 001.5 0v-1.5A.75.75 0 0020.25 6zM5.625 13.5a.75.75 0 00-1.5 0v3a.75.75 0 001.5 0v-3zM8.625 13.5a.75.75 0 00-1.5 0v3a.75.75 0 001.5 0v-3zM11.625 13.5a.75.75 0 00-1.5 0v3a.75.75 0 001.5 0v-3zM14.625 13.5a.75.75 0 00-1.5 0v3a.75.75 0 001.5 0v-3zM17.625 13.5a.75.75 0 00-1.5 0v3a.75.75 0 001.5 0v-3z" />;
    const KeyIcon = () => <Icon path="M15.75 1.5a6.75 6.75 0 00-6.651 7.906c.067.39-.032.787-.221 1.122l-.11.17a.75.75 0 00.63 1.152l3.612.903a.75.75 0 00.58-.124l1.83-1.83a.75.75 0 000-1.06l-1.83-1.83a.75.75 0 00-1.06 0l-.22.22a.75.75 0 01-1.06 0l-.053-.053a.75.75 0 010-1.06l.954-.954a4.5 4.5 0 116.364 6.364l-1.591 1.591a.75.75 0 001.06 1.06l1.591-1.59a6.75 6.75 0 00-5.651-11.082zM3 21a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z" />;
    const StarIcon = () => <Icon path="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.006z" />;
    const UsersIcon = () => <Icon path="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M12 12a3 3 0 100-6 3 3 0 000 6z" />;
    const FoodIcon = () => <Icon path="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-8.97C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5V8H21V2h-2v4h-2.5z" />;

    // =========================
    // 5) Shared UI Components
    // =========================
    const LoadingSpinner = ({ message = "ë¡œë”©ì¤‘..." }) => (
      <div className="fixed inset-0 bg-white bg-opacity-75 flex flex-col justify-center items-center z-50">
        <svg className="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p className="mt-4 text-lg font-bold text-gray-700">{message}</p>
      </div>
    );

    const Modal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto p-6" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold text-gray-800">{title}</h3>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div>{children}</div>
          </div>
        </div>
      );
    };

    // =========================
    // 6) Feature Views
    // =========================

    const PushNotificationManager = () => null;

    const AnnouncementsView = ({ announcements, onAdd, isLoading }) => {
      const TEACHER_PASSWORD = "123456";
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [isUnlocked, setIsUnlocked] = useState(false);
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [newAnnouncement, setNewAnnouncement] = useState('');

      const handlePassword = (e) => {
        e.preventDefault();
        if (password === TEACHER_PASSWORD) {
          setIsUnlocked(true);
          setIsModalOpen(false);
          setError('');
          setPassword('');
        } else {
          setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!newAnnouncement.trim()) return;
        await onAdd(newAnnouncement);
        setNewAnnouncement('');
      };

      return (
        <div className="p-4">
          <div className="bg-white p-4 rounded-xl shadow-lg">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-gray-800">ğŸ“¢ ì‹¤ì‹œê°„ ê³µì§€</h2>
              {!isUnlocked && (
                <button onClick={() => setIsModalOpen(true)} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                  ê³µì§€ ë“±ë¡
                </button>
              )}
            </div>

            <PushNotificationManager />

            {isUnlocked && (
              <form onSubmit={handleSubmit} className="mb-6">
                <textarea
                  className="w-full p-2 border rounded-md"
                  rows="3"
                  placeholder="ê³µì§€ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."
                  value={newAnnouncement}
                  onChange={e => setNewAnnouncement(e.target.value)}
                  disabled={isLoading}
                />
                <button
                  type="submit"
                  className="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md disabled:bg-gray-400"
                  disabled={isLoading}
                >
                  {isLoading ? 'ë“±ë¡ ì¤‘...' : 'ê³µì§€ ë“±ë¡'}
                </button>
              </form>
            )}

            <div className="space-y-4 max-h-[65vh] overflow-y-auto">
              {announcements && announcements.length > 0 ? announcements.map((item, i) => (
                <div key={i} className="bg-amber-100 p-4 rounded-lg border-l-4 border-amber-400">
                  <p className="text-gray-800 whitespace-pre-wrap">{item.text}</p>
                  <p className="text-right text-xs text-gray-500 mt-2">{item.timestamp}</p>
                </div>
              )) : (
                <p className="text-center text-gray-500 py-8">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              )}
            </div>
          </div>

          <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="êµì‚¬ìš© ì¸ì¦">
            <form onSubmit={handlePassword}>
              <input
                type="password"
                placeholder="ë¹„ë°€ë²ˆí˜¸"
                className="w-full p-2 border rounded-md"
                value={password}
                onChange={e => setPassword(e.target.value)}
              />
              {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
              <button type="submit" className="w-full mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-md">í™•ì¸</button>
            </form>
          </Modal>
        </div>
      );
    };

    // âœ… ìˆ™ì†Œ íƒ­: "ë°°ì • ëª…ë‹¨(ê³µê°œ)" + "êµì‚¬ìš© í¸ì§‘(ì ê¸ˆ)" ë‚´ë¶€ íƒ­ ì œê³µ
    const RoomsView = ({ roomData, teachers, students, onUpdate, isLoading }) => {
      const TEACHER_PASSWORD = "123456";

      const [mode, setMode] = useState('list'); // 'list' | 'edit'
      const [isUnlocked, setIsUnlocked] = useState(false);
      const [pw, setPw] = useState('');
      const [pwErr, setPwErr] = useState('');

      const [search, setSearch] = useState('');
      const [selectedPerson, setSelectedPerson] = useState(null);
      const [roomNum, setRoomNum] = useState('');
      const [roomType, setRoomType] = useState('2ì¸ì‹¤');

      const allPeople = useMemo(() => {
        const t = (teachers || []).map(x => x.name);
        const s = (students || []);
        return Array.from(new Set([...s, ...t])).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
      }, [teachers, students]);

      const filteredPeople = useMemo(() => {
        const list = allPeople;
        if (!search.trim()) return list;
        const q = search.toLowerCase().trim();
        return list.filter(p => p.toLowerCase().includes(q));
      }, [search, allPeople]);

      // roomData -> rooms grouped
      const groupedRooms = useMemo(() => {
        const rooms = {};
        (roomData || []).forEach(row => {
          const rnum = String(row[0] ?? '');
          const rtype = String(row[1] ?? '');
          const name = String(row[2] ?? '');
          if (!rnum || !name) return;
          if (!rooms[rnum]) rooms[rnum] = { type: rtype, members: [] };
          rooms[rnum].type = rtype || rooms[rnum].type;
          rooms[rnum].members.push(name);
        });
        // sort members
        Object.keys(rooms).forEach(k => rooms[k].members.sort((a,b)=>a.localeCompare(b, undefined, { numeric:true })));
        return rooms;
      }, [roomData]);

      const personToRoom = useMemo(() => {
        const map = new Map();
        (roomData || []).forEach(row => {
          const rnum = String(row[0] ?? '');
          const rtype = String(row[1] ?? '');
          const name = String(row[2] ?? '');
          if (!name) return;
          map.set(name, { roomNum: rnum, roomType: rtype });
        });
        return map;
      }, [roomData]);

      useEffect(() => {
        if (!selectedPerson) return;
        const current = personToRoom.get(selectedPerson);
        if (current) {
          setRoomNum(current.roomNum || '');
          setRoomType(current.roomType || '2ì¸ì‹¤');
        } else {
          setRoomNum('');
          setRoomType('2ì¸ì‹¤');
        }
      }, [selectedPerson, personToRoom]);

      const unlock = (e) => {
        e.preventDefault();
        if (pw === TEACHER_PASSWORD) {
          setIsUnlocked(true);
          setPw('');
          setPwErr('');
        } else {
          setPwErr('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      };

      const assign = async () => {
        if (!selectedPerson) return alert('ë¨¼ì € ì‚¬ëŒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        if (!roomNum.trim()) return alert('ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        if (!roomType.trim()) return alert('ë°© íƒ€ì…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        await onUpdate(googleScript.setRoomAssignment(selectedPerson, roomNum.trim(), roomType.trim()));
      };

      const remove = async (personName) => {
        if (!confirm(`${personName} ë°°ì •ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
        await onUpdate(googleScript.removeRoomAssignment(personName));
      };

      const changeRoomType = async (rnum) => {
        const newType = prompt(`${rnum}í˜¸ ë°© íƒ€ì…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2ì¸ì‹¤/3ì¸ì‹¤/4ì¸ì‹¤)`, groupedRooms[rnum]?.type || '');
        if (!newType || !newType.trim()) return;
        await onUpdate(googleScript.setRoomType(rnum, newType.trim()));
      };

      const RoomCards = () => (
        <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
          {Object.keys(groupedRooms).sort((a,b)=>a.localeCompare(b, undefined, { numeric:true })).map(roomNumKey => {
            const room = groupedRooms[roomNumKey];
            const isTeacherRoom = (room.members || []).some(m => (teachers || []).some(t => t.name === m));
            return (
              <div key={roomNumKey} className={`p-3 rounded-lg border ${isTeacherRoom ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200'} shadow-sm`}>
                <div className="flex items-start justify-between gap-2">
                  <h4 className={`font-bold ${isTeacherRoom ? 'text-red-600' : 'text-blue-600'}`}>
                    {roomNumKey}í˜¸ <span className="text-xs font-normal text-gray-500">({room.type})</span>
                  </h4>
                  {mode === 'edit' && isUnlocked && (
                    <button
                      type="button"
                      className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded"
                      onClick={() => changeRoomType(roomNumKey)}
                      disabled={isLoading}
                    >
                      íƒ€ì…ë³€ê²½
                    </button>
                  )}
                </div>

                <ul className="mt-2 text-sm space-y-1">
                  {(room.members || []).map((name, i) => (
                    <li key={i} className="flex items-center justify-between gap-2">
                      <span className={(teachers || []).some(t => t.name === name) ? 'font-bold text-red-700' : ''}>{name}</span>
                      {mode === 'edit' && isUnlocked && (
                        <button
                          type="button"
                          className="text-xs bg-red-50 text-red-600 hover:bg-red-100 px-2 py-1 rounded"
                          onClick={() => remove(name)}
                          disabled={isLoading}
                        >
                          ì‚­ì œ
                        </button>
                      )}
                    </li>
                  ))}
                </ul>
              </div>
            );
          })}
        </div>
      );

      return (
        <div className="p-4 space-y-4">
          {/* ë‚´ë¶€ íƒ­ */}
          <div className="bg-white p-3 rounded-xl shadow-lg">
            <h2 className="text-2xl font-bold text-center mb-3">ìˆ™ì†Œ ë°°ì •</h2>
            <div className="flex gap-2">
              <button
                className={`w-full py-2 rounded-lg font-bold border ${mode === 'list' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-200'}`}
                onClick={() => setMode('list')}
                type="button"
              >
                ë°°ì • ëª…ë‹¨(ê³µê°œ)
              </button>
              <button
                className={`w-full py-2 rounded-lg font-bold border ${mode === 'edit' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-200'}`}
                onClick={() => setMode('edit')}
                type="button"
              >
                êµì‚¬ìš© í¸ì§‘
              </button>
            </div>
            <p className="text-xs text-gray-500 text-center mt-2">
              ë°°ì • ëª…ë‹¨ì€ ëˆ„êµ¬ë‚˜ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í¸ì§‘ì€ êµì‚¬ìš© ì¸ì¦ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </p>
          </div>

          {/* êµì‚¬ìš© í¸ì§‘ íŒ¨ë„ */}
          {mode === 'edit' && (
            <div className="bg-white p-4 rounded-xl shadow-lg">
              {!isUnlocked ? (
                <form onSubmit={unlock} className="space-y-2">
                  <p className="text-gray-700 font-bold">êµì‚¬ìš© ì¸ì¦</p>
                  <input
                    type="password"
                    className="w-full p-2 border rounded-md"
                    placeholder="ë¹„ë°€ë²ˆí˜¸"
                    value={pw}
                    onChange={(e) => setPw(e.target.value)}
                  />
                  {pwErr && <p className="text-red-500 text-sm">{pwErr}</p>}
                  <button className="w-full bg-blue-500 text-white font-bold py-2 rounded-md">í™•ì¸</button>
                </form>
              ) : (
                <div className="space-y-3">
                  <div className="flex items-center justify-between">
                    <p className="font-bold text-green-700">ì¸ì¦ ì™„ë£Œ</p>
                    <button
                      type="button"
                      className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded"
                      onClick={() => { setIsUnlocked(false); setSelectedPerson(null); setSearch(''); }}
                    >
                      ì ê¸ˆ
                    </button>
                  </div>

                  <input
                    className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                    placeholder="í•™ìƒ/êµì‚¬ ê²€ìƒ‰"
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                  />

                  <div className="max-h-40 overflow-y-auto border rounded-lg bg-gray-50">
                    <ul className="divide-y divide-gray-200">
                      {filteredPeople.map(p => {
                        const cur = personToRoom.get(p);
                        const badge = cur ? `${cur.roomNum}í˜¸ Â· ${cur.roomType}` : 'ë¯¸ë°°ì •';
                        const badgeClass = cur ? 'bg-green-600' : 'bg-gray-400';
                        return (
                          <li
                            key={p}
                            onClick={() => setSelectedPerson(p)}
                            className={`p-3 cursor-pointer transition-colors flex items-center justify-between gap-2 ${
                              selectedPerson === p ? 'bg-blue-100 font-bold' : 'hover:bg-gray-100'
                            }`}
                          >
                            <span>{p}</span>
                            <span className={`text-xs text-white px-2 py-1 rounded-full ${badgeClass}`}>{badge}</span>
                          </li>
                        );
                      })}
                    </ul>
                  </div>

                  <div className="border rounded-lg p-3 bg-white">
                    <p className="text-sm text-gray-700">
                      ì„ íƒ: <span className="font-bold text-blue-600">{selectedPerson || 'ì—†ìŒ'}</span>
                    </p>

                    <div className="grid grid-cols-2 gap-2 mt-3">
                      <input
                        className="w-full p-2 border rounded-md"
                        placeholder="ë°© ë²ˆí˜¸ (ì˜ˆ: 101)"
                        value={roomNum}
                        onChange={(e) => setRoomNum(e.target.value)}
                        disabled={!selectedPerson}
                      />
                      <select
                        className="w-full p-2 border rounded-md bg-white"
                        value={roomType}
                        onChange={(e) => setRoomType(e.target.value)}
                        disabled={!selectedPerson}
                      >
                        <option value="2ì¸ì‹¤">2ì¸ì‹¤</option>
                        <option value="3ì¸ì‹¤">3ì¸ì‹¤</option>
                        <option value="4ì¸ì‹¤">4ì¸ì‹¤</option>
                        <option value="êµì‚¬ì‹¤">êµì‚¬ì‹¤</option>
                      </select>
                    </div>

                    <div className="grid grid-cols-2 gap-2 mt-3">
                      <button
                        type="button"
                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg disabled:bg-gray-300"
                        onClick={assign}
                        disabled={!selectedPerson || isLoading}
                      >
                        {isLoading ? 'ì €ì¥ ì¤‘...' : 'ë°°ì •/ìˆ˜ì •'}
                      </button>
                      <button
                        type="button"
                        className="w-full bg-red-50 hover:bg-red-100 text-red-600 font-bold py-2 rounded-lg disabled:text-gray-400"
                        onClick={() => selectedPerson ? remove(selectedPerson) : null}
                        disabled={!selectedPerson || isLoading}
                      >
                        ë°°ì • ì‚­ì œ
                      </button>
                    </div>

                    <p className="text-xs text-gray-500 mt-2">
                      â€» í•œ ì‚¬ëŒì€ í•œ ë°©ì—ë§Œ ë°°ì •ë©ë‹ˆë‹¤(ë°°ì • ì‹œ ê¸°ì¡´ ë°°ì •ì€ ìë™ ì œê±°).
                    </p>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ëª…ë‹¨ ì˜ì—­ (í•­ìƒ ê³µê°œ) */}
          <div className="bg-white p-4 rounded-xl shadow-lg">
            <h3 className="font-bold text-gray-800 mb-3">
              {mode === 'edit' ? 'í˜„ì¬ ë°°ì • í˜„í™©(í¸ì§‘ ê°€ëŠ¥)' : 'ìˆ™ì†Œ ë°°ì • ëª…ë‹¨'}
            </h3>
            {Object.keys(groupedRooms).length > 0 ? (
              <RoomCards />
            ) : (
              <p className="text-center text-gray-500 py-10">ë°°ì •ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            )}
          </div>
        </div>
      );
    };

    const ScheduleInfoView = ({ teachers }) => {
      const schedule = {
        "1ì¼ì°¨ (01/20 í™”)": [
          { text: "07:40 í•™êµ ì¶œë°œ" },
          { text: "12:00 ì ì‹¬ ì‹ì‚¬(ê²½í¬ ë©´ì˜¥)" },
          { text: "13:00 ì„ íƒ í”„ë¡œê·¸ë¨(êµ­ì¤‘ë°•/KBS)" },
          { text: "17:30 ì €ë… ì‹ì‚¬(íŒŒí‹°ì•¤í”„ë Œì¦ˆ)", url: "http://partynfriends.com/" },
          { text: "19:00 ì—°ê·¹ ê´€ëŒ(ì°½ì‹ ì•„íŠ¸í™€)", url: "https://ko.wikipedia.org/wiki/%ED%95%9C%EC%97%AC%EB%A6%84_%EB%B0%A4%EC%9D%98_%EA%BF%88" },
          { text: "21:30 ìˆ™ì†Œ ë„ì°©(íŒŒí¬í•˜ë¹„ì˜¤)", url: "http://www.hotelparkhabio.co.kr/jp/" }
        ],
        "2ì¼ì°¨ (01/21 ìˆ˜)": [
          { text: "09:00 ìˆ™ì†Œ ì¶œë°œ" },
          { text: "10:00 ë¡¯ë°ì›”ë“œ(ì„œìš¸ìŠ¤ì¹´ì´[ì„ íƒ])", url: "https://seoulsky.lotteworld.com/" },
          { text: "19:00 ìˆ™ì†Œ ë³µê·€" }
        ],
        "3ì¼ì°¨ (01/22 ëª©)": [
          { text: "08:30 ìˆ™ì†Œ ì¶œë°œ" },
          { text: "10:00 ê²½ë³µê¶", url: "https://www.heritage.go.kr/heri/html/HtmlPage.do?pg=/palaces/palacesRoyalInfo.jsp&pageNo=2_1_1_1" },
          { text: "12:00 ì ì‹¬ ì‹ì‚¬" },
          { text: "14:00 ì„œìš¸ëŒ€ íƒë°©(ì„œìš¸ëŒ€ í•™ì‹)" },
          { text: "20:00 í•™êµ ë„ì°© ì˜ˆì •" }
        ]
      };
      const packing = ["ì—¬ë²Œ ì˜·", "ì ì˜·", "ì†ì˜·/ì–‘ë§", "í¸í•œ ì‹ ë°œ", "ì„¸ë©´ë„êµ¬", "ìƒë¹„ì•½", "ì¶©ì „ê¸°", "ìš©ëˆ", "ìš°ì‚°"];

      return (
        <div className="p-4 space-y-6">
          <div>
            <h2 className="text-2xl font-bold text-center mb-6">ğŸ—“ï¸ ì „ì²´ ì¼ì •</h2>
            <div className="space-y-4">
              {Object.entries(schedule).map(([day, items]) => (
                <div key={day} className="bg-white p-4 rounded-lg shadow">
                  <h3 className="font-bold text-blue-600 mb-2">{day}</h3>
                  <ul className="list-disc list-inside text-sm text-gray-700 space-y-1">
                    {items.map(item => (
                      <li key={item.text}>
                        {item.url ? (
                          <a href={item.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
                            {item.text} <span role="img" aria-label="link">ğŸ”—</span>
                          </a>
                        ) : item.text}
                      </li>
                    ))}
                  </ul>
                </div>
              ))}
            </div>
          </div>

          <div>
            <h2 className="text-2xl font-bold text-center mb-6">â„¹ï¸ í•„ìˆ˜ ì •ë³´</h2>
            <div className="space-y-4">
              <div className="bg-white p-4 rounded-lg shadow">
                <h3 className="font-bold text-red-600 mb-2">ğŸš¨ ë¹„ìƒ ì—°ë½ë§</h3>
                <ul className="list-disc list-inside text-sm text-gray-700 space-y-1">
                  {teachers && teachers.map(teacher => (
                    <li key={teacher.name}>{teacher.name} {teacher.contact}</li>
                  ))}
                </ul>
              </div>

              <div className="bg-white p-4 rounded-lg shadow">
                <h3 className="font-bold text-indigo-600 mb-2">ğŸ’ ê°œì¸ ì¤€ë¹„ë¬¼</h3>
                <ul className="list-disc list-inside text-sm text-gray-700 grid grid-cols-2 gap-1">
                  {packing.map(p => <li key={p}>{p}</li>)}
                </ul>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const BusView = ({ data, onUpdate, isLoading }) => {
      const [busNumber, setBusNumber] = useState('1');
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [selectedSeat, setSelectedSeat] = useState(null);

      const TEACHER_PASSWORD = "123456";
      const [isResetModalOpen, setIsResetModalOpen] = useState(false);
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [busToReset, setBusToReset] = useState(null);

      const getSeatDisplayName = (studentName) => {
        if (!studentName) return '';
        const parts = studentName.split(' ');
        if (parts.length > 2) return parts[2];
        return studentName;
      };

      const boardedStudents = useMemo(() => new Set(Object.values(data.busData).flatMap(bus => Object.values(bus))), [data.busData]);
      const unboardedStudents = useMemo(() => data.students.filter(s => !boardedStudents.has(s)), [data.students, boardedStudents]);

      const handleSeatClick = (seat) => {
        const studentName = data.busData[busNumber]?.[seat];
        if (studentName) {
          if (confirm(`[${studentName}] í•™ìƒì„ ì¢Œì„ì—ì„œ ë‚´ë¦¬ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            onUpdate(googleScript.updateBusSeat(busNumber, seat, ''));
          }
        } else {
          setSelectedSeat(seat);
          setIsModalOpen(true);
        }
      };

      const handleSelectStudent = async (studentName) => {
        setIsModalOpen(false);
        if (!studentName) return;
        await onUpdate(googleScript.updateBusSeat(busNumber, selectedSeat, studentName));
      };

      const openResetModal = (busNum) => {
        setBusToReset(busNum);
        setPassword('');
        setError('');
        setIsResetModalOpen(true);
      };

      const handlePasswordAndReset = async (e) => {
        e.preventDefault();
        if (password !== TEACHER_PASSWORD) {
          setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        setIsResetModalOpen(false);
        if (confirm(`${busToReset}í˜¸ì°¨ íƒ‘ìŠ¹ ì •ë³´ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
          await onUpdate(googleScript.resetBus(busToReset));
        }
        setPassword('');
        setError('');
        setBusToReset(null);
      };

      const StudentSelectModal = () => {
        const [searchTerm, setSearchTerm] = useState('');
        const filteredStudents = useMemo(() => {
          if (!searchTerm.trim()) return unboardedStudents.slice().sort();
          const t = searchTerm.toLowerCase().trim();
          return unboardedStudents.filter(s => s.toLowerCase().includes(t)).sort();
        }, [searchTerm, unboardedStudents]);

        return (
          <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={`${busNumber}í˜¸ì°¨ ${selectedSeat}ë²ˆ ì¢Œì„ ë°°ì •`}>
            <div className="flex flex-col space-y-4">
              <input
                type="text"
                placeholder="ì´ë¦„ ë˜ëŠ” í•™ë²ˆìœ¼ë¡œ ê²€ìƒ‰"
                className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                autoFocus
              />
              <div className="max-h-64 overflow-y-auto border rounded-lg bg-gray-50">
                {filteredStudents.length > 0 ? (
                  <ul className="divide-y divide-gray-200">
                    {filteredStudents.map(student => (
                      <li key={student} className="p-3 hover:bg-blue-100 cursor-pointer transition-colors duration-150" onClick={() => handleSelectStudent(student)}>
                        {student}
                      </li>
                    ))}
                  </ul>
                ) : (
                  <p className="p-4 text-center text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                )}
              </div>
            </div>
          </Modal>
        );
      };

      return (
        <div className="p-4">
          <Modal isOpen={isResetModalOpen} onClose={() => setIsResetModalOpen(false)} title={`${busToReset}í˜¸ì°¨ ì´ˆê¸°í™” ì¸ì¦`}>
            <form onSubmit={handlePasswordAndReset}>
              <p className="mb-4 text-gray-600">êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ì´ˆê¸°í™”ë¥¼ ìŠ¹ì¸í•˜ì„¸ìš”.</p>
              <input
                type="password"
                placeholder="ë¹„ë°€ë²ˆí˜¸"
                className="w-full p-2 border rounded-md"
                value={password}
                onChange={e => setPassword(e.target.value)}
              />
              {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
              <button type="submit" className="w-full mt-4 bg-red-500 text-white font-bold py-2 px-4 rounded-md">ì´ˆê¸°í™” ìŠ¹ì¸</button>
            </form>
          </Modal>

          {isModalOpen && <StudentSelectModal />}

          <div className="flex justify-around border-b mb-4 bg-white rounded-t-lg">
            {[1, 2, 3].map(num => (
              <button
                key={num}
                onClick={() => setBusNumber(String(num))}
                className={`py-3 px-4 text-lg font-bold w-full rounded-t-md ${busNumber == num ? 'text-blue-600 border-b-4 border-blue-600' : 'text-gray-500'}`}
              >
                {num}í˜¸ì°¨
              </button>
            ))}
          </div>

          <div className="bg-white p-4 rounded-lg shadow-md mb-4">
            <div className="bg-gray-200 rounded-lg p-2 grid grid-cols-5 gap-2 w-max mx-auto text-xs text-center">
              <div className="col-span-2 bg-gray-600 text-white rounded p-2 flex items-center justify-center">ìš´ì „ì„</div>
              <div className="col-span-1"></div>
              <div className="col-span-2 bg-gray-400 text-white rounded p-2 flex items-center justify-center">ì…êµ¬</div>

              {Array.from({ length: 45 }, (_, i) => i + 1).map(seat => {
                const student = data.busData[busNumber]?.[seat];
                const isOccupied = !!student;
                const styleIndex = seat;
                const gridCol = styleIndex <= 40 ? ((((styleIndex - 1) % 4) < 2) ? (((styleIndex - 1) % 4) + 1) : (((styleIndex - 1) % 4) + 2)) : (styleIndex - 40);
                const gridRow = styleIndex > 40 ? 12 : Math.floor((styleIndex - 1) / 4) + 2;
                return (
                  <div
                    key={seat}
                    className={`h-10 rounded flex items-center justify-center font-bold transition-transform transform cursor-pointer hover:scale-110 ${isOccupied ? 'bg-green-600 text-white' : 'bg-gray-300'}`}
                    style={{ gridColumn: gridCol, gridRow: gridRow }}
                    onClick={() => handleSeatClick(seat)}
                  >
                    {isOccupied ? getSeatDisplayName(student) : seat}
                  </div>
                );
              })}
            </div>

            <button
              onClick={() => openResetModal(busNumber)}
              className="w-full mt-4 bg-red-500 text-white font-bold py-2 rounded-lg disabled:bg-gray-400"
              disabled={isLoading}
            >
              {isLoading ? 'ì´ˆê¸°í™” ì¤‘...' : 'ì´ˆê¸°í™”'}
            </button>
          </div>

          <div className="bg-white p-4 rounded-lg shadow-md">
            <h3 className="font-bold mb-2">ë¯¸íƒ‘ìŠ¹ í•™ìƒ ({unboardedStudents.length}ëª…)</h3>
            <div className="max-h-40 overflow-y-auto text-sm flex flex-wrap gap-2">
              {unboardedStudents.slice().sort().map(s => <span key={s} className="bg-yellow-100 px-2 py-1 rounded">{s}</span>)}
            </div>
          </div>
        </div>
      );
    };

    const MealView = ({ data, onUpdate, isLoading }) => {
      const [selectedStudent, setSelectedStudent] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [isUnlocked, setIsUnlocked] = useState(false);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [localChoices, setLocalChoices] = useState({});
      const [viewMode, setViewMode] = useState('student_search');
      const TEACHER_PASSWORD = "123456";

      useEffect(() => {
        if (selectedStudent && data.mealMenus) {
          const initial = {};
          data.mealMenus.forEach(menu => {
            const mealId = menu[0];
            const choice = data.mealChoices?.[mealId]?.[selectedStudent];
            if (choice) initial[mealId] = choice;
          });
          setLocalChoices(initial);
        }
      }, [selectedStudent, data.mealMenus, data.mealChoices]);

      const mealStats = useMemo(() => {
        if (!data.mealMenus || !data.mealChoices || !data.students) return {};
        const stats = {};
        const allStudentSet = new Set(data.students);

        data.mealMenus.forEach(menu => {
          const mealId = menu[0];
          const title = menu[1];
          const options = menu.slice(2).filter(opt => opt.trim() !== '');
          if (options.length < 2) return;

          const choicesForThisMeal = data.mealChoices[mealId] || {};
          const studentsWhoChose = new Set(Object.keys(choicesForThisMeal));
          const studentsWhoDidNotChoose = [...allStudentSet].filter(s => !studentsWhoChose.has(s));

          stats[mealId] = {
            title,
            options: {},
            totalChosenCount: studentsWhoChose.size,
            studentsWhoDidNotChoose: studentsWhoDidNotChoose.sort(),
          };

          options.forEach(option => { stats[mealId].options[option] = { count: 0 }; });

          for (const studentName in choicesForThisMeal) {
            const choice = choicesForThisMeal[studentName];
            if (stats[mealId].options[choice]) stats[mealId].options[choice].count++;
          }
        });

        return stats;
      }, [data.mealMenus, data.mealChoices, data.students]);

      const handlePassword = (e) => {
        e.preventDefault();
        if (password === TEACHER_PASSWORD) {
          setIsUnlocked(true);
          setIsModalOpen(false);
          setError('');
          setPassword('');
          setViewMode('status');
        } else {
          setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      };

      const handleSelectMeal = (mealId, choice) => {
        setLocalChoices(prev => ({ ...prev, [mealId]: choice }));
      };

      const handleSaveAll = async () => {
        await onUpdate(googleScript.saveAllMealChoices(selectedStudent, localChoices));
      };

      const filteredStudents = useMemo(() => {
        const list = data.students.slice().sort();
        if (!searchTerm.trim()) return list;
        const t = searchTerm.toLowerCase().trim();
        return list.filter(s => s.toLowerCase().includes(t)).sort();
      }, [searchTerm, data.students]);

      const handleStudentSelect = (student) => {
        setSelectedStudent(student);
        setViewMode('student_form');
      };

      const handleBackFromForm = () => {
        setSelectedStudent(null);
        setLocalChoices({});
        setViewMode(isUnlocked ? 'status' : 'student_search');
      };

      const ProgressBar = ({ value, max, colorClass }) => {
        const pct = max > 0 ? (value / max) * 100 : 0;
        return (
          <div className="w-full bg-gray-200 rounded-full h-2.5">
            <div className={`${colorClass} h-2.5 rounded-full`} style={{ width: `${pct}%` }}></div>
          </div>
        );
      };

      if (viewMode === 'student_form' && selectedStudent) {
        const totalMeals = data.mealMenus?.filter(m => m.slice(2).some(opt => opt !== '')).length || 0;
        const selectedMeals = Object.keys(localChoices).length;

        return (
          <div className="p-4 space-y-4">
            <div className="bg-white p-4 rounded-xl shadow-lg">
              <div className="flex justify-between items-center">
                <h2 className="text-xl font-bold text-blue-600">{selectedStudent}</h2>
                <span className="font-bold text-gray-700">{`(${selectedMeals} / ${totalMeals} ì„ íƒ ì™„ë£Œ)`}</span>
              </div>
              <button onClick={handleBackFromForm} className="text-sm bg-gray-200 px-3 py-1 rounded-md mt-2">ë’¤ë¡œê°€ê¸°</button>
            </div>

            {data.mealMenus && data.mealMenus.map(menu => {
              const mealId = menu[0];
              const mealTitle = menu[1];
              const options = menu.slice(2).filter(opt => opt !== '');
              const currentChoice = localChoices[mealId];
              if (options.length === 0) return null;

              return (
                <div key={mealId} className="bg-white p-4 rounded-xl shadow-lg">
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{mealTitle}</h3>
                  {options.length === 1 ? (
                    <p className="text-gray-500 bg-gray-100 p-3 rounded-md text-center">{options[0]}</p>
                  ) : (
                    <div className="flex flex-wrap gap-2">
                      {options.map(option => {
                        const isSelected = currentChoice === option;
                        return (
                          <button
                            key={option}
                            onClick={() => handleSelectMeal(mealId, option)}
                            className={`flex-grow p-3 text-center rounded-lg border-2 font-semibold transition-all
                              ${isSelected ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-blue-600 border-blue-500 hover:bg-blue-50'}
                            `}
                          >
                            {option}
                          </button>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })}

            <div className="pt-4">
              <button
                onClick={handleSaveAll}
                disabled={isLoading}
                className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg disabled:bg-gray-400 disabled:cursor-not-allowed"
              >
                {isLoading ? 'ì €ì¥ ì¤‘...' : 'ì „ì²´ ì„ íƒ ì €ì¥'}
              </button>
            </div>
          </div>
        );
      }

      if (isUnlocked && viewMode === 'status') {
        const totalStudents = data.students.length;
        return (
          <div className="p-4 space-y-4">
            <div className="bg-white p-4 rounded-xl shadow-lg">
              <h2 className="text-2xl font-bold text-gray-800 text-center">ğŸ½ï¸ ì‹ì‚¬ ì„ íƒ í˜„í™©</h2>
              <p className="text-center text-gray-500 mt-1">ì „ì²´ í•™ìƒ: {totalStudents}ëª…</p>
              <button
                onClick={() => setViewMode('student_search')}
                className="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md"
              >
                í•™ìƒë³„ ì„ íƒ/ìˆ˜ì •í•˜ê¸°
              </button>
            </div>

            {Object.keys(mealStats).length > 0 ? Object.entries(mealStats).map(([mealId, stats]) => (
              <div key={mealId} className="bg-white p-4 rounded-xl shadow-lg">
                <h3 className="font-bold text-lg text-gray-800 mb-2">{stats.title}</h3>
                <div className="text-sm font-semibold text-gray-600 mb-3">
                  {stats.totalChosenCount} / {totalStudents} ëª… ì„ íƒ ì™„ë£Œ
                </div>

                <div className="space-y-3">
                  {Object.entries(stats.options).map(([option, details]) => (
                    <div key={option}>
                      <div className="flex justify-between items-center mb-1 text-sm">
                        <span className="font-medium text-gray-700">{option}</span>
                        <span className="font-bold text-blue-600">{details.count}ëª…</span>
                      </div>
                      <ProgressBar value={details.count} max={totalStudents} colorClass="bg-blue-500" />
                    </div>
                  ))}
                </div>

                {stats.studentsWhoDidNotChoose.length > 0 && (
                  <details className="mt-4">
                    <summary className="text-sm font-semibold text-red-600 cursor-pointer">
                      ë¯¸ì„ íƒ í•™ìƒ ({stats.studentsWhoDidNotChoose.length}ëª…)
                    </summary>
                    <div className="text-xs flex flex-wrap gap-x-3 gap-y-1 text-gray-600 mt-2 p-2 bg-gray-50 rounded-md">
                      {stats.studentsWhoDidNotChoose.map(s => <span key={s}>{s}</span>)}
                    </div>
                  </details>
                )}
              </div>
            )) : (
              <div className="text-center text-gray-500 py-8 bg-white rounded-xl shadow-lg">í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            )}
          </div>
        );
      }

      if (viewMode === 'student_search') {
        return (
          <div className="p-4 flex flex-col h-full">
            <div className="bg-white p-4 rounded-xl shadow-lg mb-4 shrink-0">
              <h2 className="text-2xl font-bold text-gray-800 text-center">ëˆ„êµ¬ì‹ ê°€ìš”?</h2>
              <p className="text-center text-gray-500 text-sm mt-2">ë¨¼ì € ëª…ë‹¨ì—ì„œ ë³¸ì¸ ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>

              {!isUnlocked && (
                <button onClick={() => setIsModalOpen(true)} className="w-full mt-3 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm">
                  êµì‚¬ìš©
                </button>
              )}

              {isUnlocked && (
                <button onClick={() => setViewMode('status')} className="w-full mt-3 bg-green-200 text-green-800 font-bold py-2 px-4 rounded-lg text-sm">
                  í˜„í™© ë³´ê¸°ë¡œ ëŒì•„ê°€ê¸°
                </button>
              )}

              <div className="mt-4">
                <input
                  type="text"
                  placeholder="ì´ë¦„ ë˜ëŠ” í•™ë²ˆìœ¼ë¡œ ê²€ìƒ‰..."
                  className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  value={searchTerm}
                  onChange={e => setSearchTerm(e.target.value)}
                />
              </div>
            </div>

            <div className="flex-grow overflow-y-auto bg-white rounded-xl shadow-lg">
              <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="êµì‚¬ìš© ì¸ì¦">
                <form onSubmit={handlePassword}>
                  <input
                    type="password"
                    placeholder="ë¹„ë°€ë²ˆí˜¸"
                    className="w-full p-2 border rounded-md"
                    value={password}
                    onChange={e => setPassword(e.target.value)}
                  />
                  {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                  <button type="submit" className="w-full mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-md">í™•ì¸</button>
                </form>
              </Modal>

              <ul className="divide-y divide-gray-200">
                {filteredStudents.map(student => (
                  <li
                    key={student}
                    className="p-4 hover:bg-blue-100 cursor-pointer transition-colors duration-150 font-semibold"
                    onClick={() => handleStudentSelect(student)}
                  >
                    {student}
                  </li>
                ))}
              </ul>
            </div>
          </div>
        );
      }

      return null;
    };

    const AllStudentsView = ({ students, busData, activities }) => {
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedClass, setSelectedClass] = useState('all');
      const [selectedBus, setSelectedBus] = useState('all');

      const handleClearFilters = () => {
        setSearchTerm('');
        setSelectedClass('all');
        setSelectedBus('all');
      };

      const isFiltered = searchTerm.trim() !== '' || selectedClass !== 'all' || selectedBus !== 'all';

      const studentDetails = useMemo(() => {
        if (!students || !busData || !activities) return [];
        const activityMap = new Map();
        for (const [key, list] of Object.entries(activities || {})) {
          let name = '';
          if (key.includes('kbs')) name = 'KBS';
          else if (key.includes('museum')) name = 'êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€';
          else if (key.includes('sky')) name = 'ì„œìš¸ìŠ¤ì¹´ì´';
          if (!name) continue;
          (list || []).forEach(student => activityMap.set(student, name));
        }
        const busMap = new Map();
        for (const busNum in (busData || {})) {
          for (const seat in (busData[busNum] || {})) {
            busMap.set(busData[busNum][seat], `${busNum}í˜¸ì°¨ ${seat}ë²ˆ`);
          }
        }
        return students.slice().sort().map(student => ({
          name: student,
          busInfo: busMap.get(student) || 'ë¯¸íƒ‘ìŠ¹',
          activityInfo: activityMap.get(student) || 'ì—†ìŒ'
        }));
      }, [students, busData, activities]);

      const uniqueClasses = useMemo(() => {
        const classSet = new Set((students || []).map(s => s.split(' ')[0]));
        return Array.from(classSet).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
      }, [students]);

      const uniqueBuses = useMemo(() => Object.keys(busData || {}).sort((a, b) => a.localeCompare(b, undefined, { numeric: true })), [busData]);

      const filteredStudents = useMemo(() => {
        let results = studentDetails;
        if (searchTerm.trim()) {
          const t = searchTerm.toLowerCase().trim();
          results = results.filter(s => s.name.toLowerCase().includes(t));
        }
        if (selectedClass !== 'all') {
          results = results.filter(s => s.name.startsWith(selectedClass));
        }
        if (selectedBus !== 'all') {
          if (selectedBus === 'unboarded') results = results.filter(s => s.busInfo === 'ë¯¸íƒ‘ìŠ¹');
          else results = results.filter(s => s.busInfo.startsWith(`${selectedBus}í˜¸ì°¨`));
        }
        return results;
      }, [studentDetails, searchTerm, selectedClass, selectedBus]);

      return (
        <div className="p-4 flex flex-col h-full">
          <div className="bg-white p-4 rounded-xl shadow-lg mb-4 shrink-0">
            <h2 className="text-2xl font-bold text-gray-800 text-center">ğŸ§‘â€ğŸ“ ì „ì²´ í•™ìƒ ëª…ë‹¨ ({filteredStudents.length}ëª…)</h2>

            <div className="mt-4 space-y-3">
              <input
                type="text"
                placeholder="ì´ë¦„ ë˜ëŠ” í•™ë²ˆìœ¼ë¡œ ê²€ìƒ‰..."
                className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
              />

              <div className="grid grid-cols-2 gap-2">
                <select
                  value={selectedClass}
                  onChange={e => setSelectedClass(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white appearance-none text-center"
                >
                  <option value="all">ì „ì²´ ë°˜</option>
                  {uniqueClasses.map(cls => <option key={cls} value={cls}>{cls}</option>)}
                </select>

                <select
                  value={selectedBus}
                  onChange={e => setSelectedBus(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white appearance-none text-center"
                >
                  <option value="all">ì „ì²´ ë²„ìŠ¤</option>
                  {uniqueBuses.map(bus => <option key={bus} value={bus}>{bus}í˜¸ì°¨</option>)}
                  <option value="unboarded">ë¯¸íƒ‘ìŠ¹</option>
                </select>
              </div>

              {isFiltered && (
                <button onClick={handleClearFilters} className="w-full text-sm text-center text-gray-600 hover:text-blue-600 font-semibold py-2 px-4 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                  í•„í„° ì´ˆê¸°í™”
                </button>
              )}
            </div>
          </div>

          <div className="flex-grow overflow-y-auto bg-white rounded-xl shadow-lg">
            <ul className="divide-y divide-gray-200">
              {filteredStudents.length > 0 ? (
                filteredStudents.map(student => (
                  <li key={student.name} className="p-4 hover:bg-gray-50">
                    <p className="font-semibold text-gray-800">{student.name}</p>
                    <div className="flex items-center space-x-2 mt-2 text-xs">
                      <span className={`px-2 py-1 rounded-full text-white ${student.busInfo === 'ë¯¸íƒ‘ìŠ¹' ? 'bg-gray-400' : 'bg-green-600'}`}>
                        {student.busInfo}
                      </span>
                      <span className={`px-2 py-1 rounded-full text-white ${student.activityInfo === 'ì—†ìŒ' ? 'bg-gray-400' : 'bg-blue-600'}`}>
                        {student.activityInfo}
                      </span>
                    </div>
                  </li>
                ))
              ) : (
                <li className="p-4 text-center text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
              )}
            </ul>
          </div>
        </div>
      );
    };

    const ActivityMissionView = ({ activities, missions, data, onUpdate, isLoading }) => {
      const missionsByDay = useMemo(() => {
        const groups = {};
        if (missions) {
          missions.forEach(([day, place, content]) => {
            if (!groups[day]) groups[day] = [];
            groups[day].push({ place, content });
          });
        }
        return groups;
      }, [missions]);

      const day1_kbs_list = activities?.day1_kbs || [];
      const day1_museum_list = activities?.day1_museum || [];
      const day2_sky_list = activities?.day2_sky || [];

      const TEACHER_PASSWORD = "123456";
      const [isUnlocked, setIsUnlocked] = useState(false);
      const [pw, setPw] = useState('');
      const [pwErr, setPwErr] = useState('');

      const [search, setSearch] = useState('');
      const [selectedStudent, setSelectedStudent] = useState(null);

      const filteredStudents = useMemo(() => {
        const list = (data?.students || []).slice().sort();
        if (!search.trim()) return list;
        const t = search.toLowerCase().trim();
        return list.filter(s => s.toLowerCase().includes(t));
      }, [search, data?.students]);

      const currentActivityLabel = useMemo(() => {
        if (!selectedStudent || !activities) return 'ì—†ìŒ';
        if ((activities.day1_kbs || []).includes(selectedStudent)) return 'KBS';
        if ((activities.day1_museum || []).includes(selectedStudent)) return 'êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€';
        if ((activities.day2_sky || []).includes(selectedStudent)) return 'ì„œìš¸ìŠ¤ì¹´ì´';
        return 'ì—†ìŒ';
      }, [selectedStudent, activities]);

      const unlock = (e) => {
        e.preventDefault();
        if (pw === TEACHER_PASSWORD) {
          setIsUnlocked(true);
          setPw('');
          setPwErr('');
        } else {
          setPwErr('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      };

      const activityButtons = [
        { key: 'day1_kbs', label: 'KBS' },
        { key: 'day1_museum', label: 'êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€' },
        { key: 'day2_sky', label: 'ì„œìš¸ìŠ¤ì¹´ì´' },
        { key: 'none', label: 'ì—†ìŒ' },
      ];

      const setActivity = async (activityKey) => {
        if (!selectedStudent) return;
        await onUpdate(googleScript.updateStudentActivity(selectedStudent, activityKey));
      };

      return (
        <div className="p-4 space-y-8">
          <div className="bg-white p-4 rounded-xl shadow-lg">
            <div className="flex items-center justify-between">
              <h2 className="text-xl font-bold text-gray-800">ğŸ›ï¸ ì„ íƒí™œë™ ì§€ì •(êµì‚¬ìš©)</h2>
              {!isUnlocked ? (
                <span className="text-xs text-gray-500">ì ê¸ˆ ìƒíƒœ</span>
              ) : (
                <span className="text-xs text-green-600 font-bold">ì ê¸ˆ í•´ì œë¨</span>
              )}
            </div>

            {!isUnlocked ? (
              <form onSubmit={unlock} className="mt-4 space-y-2">
                <input
                  type="password"
                  className="w-full p-2 border rounded-md"
                  placeholder="ë¹„ë°€ë²ˆí˜¸"
                  value={pw}
                  onChange={e => setPw(e.target.value)}
                />
                {pwErr && <p className="text-red-500 text-sm">{pwErr}</p>}
                <button className="w-full bg-blue-500 text-white font-bold py-2 rounded-md">í™•ì¸</button>
              </form>
            ) : (
              <div className="mt-4 space-y-3">
                <input
                  className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  placeholder="í•™ìƒ ê²€ìƒ‰(ì´ë¦„/ë°˜/ë²ˆí˜¸)"
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                />

                <div className="max-h-40 overflow-y-auto border rounded-lg bg-gray-50">
                  <ul className="divide-y divide-gray-200">
                    {filteredStudents.map(s => (
                      <li
                        key={s}
                        onClick={() => setSelectedStudent(s)}
                        className={`p-3 cursor-pointer transition-colors ${
                          selectedStudent === s ? 'bg-blue-100 font-bold' : 'hover:bg-gray-100'
                        }`}
                      >
                        {s}
                      </li>
                    ))}
                  </ul>
                </div>

                <div className="bg-white border rounded-lg p-3">
                  <p className="text-sm text-gray-700">
                    ì„ íƒ í•™ìƒ: <span className="font-bold text-blue-600">{selectedStudent || 'ì—†ìŒ'}</span>
                  </p>
                  <p className="text-sm text-gray-700 mt-1">
                    í˜„ì¬ í™œë™: <span className="font-bold text-indigo-600">{currentActivityLabel}</span>
                  </p>

                  <div className="grid grid-cols-2 gap-2 mt-3">
                    {activityButtons.map(b => (
                      <button
                        key={b.key}
                        type="button"
                        disabled={!selectedStudent || isLoading}
                        onClick={() => setActivity(b.key)}
                        className={`py-2 rounded-lg border-2 font-bold transition-all
                          ${!selectedStudent ? 'bg-gray-100 text-gray-400 border-gray-200' : 'bg-white text-blue-600 border-blue-500 hover:bg-blue-50'}
                        `}
                      >
                        {b.label}
                      </button>
                    ))}
                  </div>

                  <p className="text-xs text-gray-500 mt-2">
                    â€» ì—¬ê¸°ì„œ ì§€ì •í•˜ë©´ â€œì „ì²´í•™ìƒâ€ íƒ­ì˜ íŒŒë€ ë¼ë²¨ì´ ìë™ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            )}
          </div>

          <div>
            <h2 className="text-2xl font-bold text-center mb-6">ğŸ† ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</h2>
            {['1ì¼ì°¨', '2ì¼ì°¨', '3ì¼ì°¨'].map(day => (
              missionsByDay[day] && (
                <div key={day} className="mb-6">
                  <h3 className="text-xl font-bold text-blue-600 border-l-4 border-blue-600 pl-3 mb-4">{day}</h3>
                  <div className="space-y-3">
                    {missionsByDay[day].map((m, i) => (
                      <div key={i} className="bg-white p-4 rounded-lg shadow-sm">
                        <p className="font-semibold text-gray-600">{m.place}</p>
                        <p className="mt-1 text-gray-800">{m.content}</p>
                      </div>
                    ))}
                  </div>
                </div>
              )
            ))}
          </div>

          <div>
            <h2 className="text-2xl font-bold text-center mb-6">âœ¨ ì„ íƒ í™œë™</h2>
            <div className="space-y-4 max-w-2xl mx-auto">
              <div className="bg-white p-4 rounded-lg shadow">
                <h3 className="font-bold mb-2">1ì¼ì°¨ KBS ({day1_kbs_list.length}ëª…)</h3>
                <ul className="text-sm flex flex-wrap gap-2">
                  {day1_kbs_list.slice().sort().map(s => <li key={s} className="bg-gray-100 px-2 py-1 rounded">{s}</li>)}
                </ul>
              </div>

              <div className="bg-white p-4 rounded-lg shadow">
                <h3 className="font-bold mb-2">1ì¼ì°¨ êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€ ({day1_museum_list.length}ëª…)</h3>
                <ul className="text-sm flex flex-wrap gap-2">
                  {day1_museum_list.slice().sort().map(s => <li key={s} className="bg-gray-100 px-2 py-1 rounded">{s}</li>)}
                </ul>
              </div>

              <div className="bg-white p-4 rounded-lg shadow">
                <h3 className="font-bold mb-2">2ì¼ì°¨ ì„œìš¸ìŠ¤ì¹´ì´ ({day2_sky_list.length}ëª…)</h3>
                <ul className="text-sm flex flex-wrap gap-2">
                  {day2_sky_list.slice().sort().map(s => <li key={s} className="bg-gray-100 px-2 py-1 rounded">{s}</li>)}
                </ul>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // =========================
    // 7) Main App
    // =========================
    const App = () => {
      const [view, setView] = useState('announcement');
      const [data, setData] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState(null);
      const [lastUpdated, setLastUpdated] = useState(null);

      const CACHE_KEY = 'schoolTripData_v3';

      const updateStateAndCache = (newData) => {
        const ts = new Date();
        setData(newData);
        setLastUpdated(ts);
        try {
          localStorage.setItem(CACHE_KEY, JSON.stringify({ data: newData, timestamp: ts.toISOString() }));
        } catch (e) {
          console.error('cache write failed', e);
        }
      };

      const registerServiceWorker = () => {
        if ('serviceWorker' in navigator) {
          const scriptUrl = new URL(location.href);
          scriptUrl.searchParams.set('path', 'sw.js');
          navigator.serviceWorker.register(scriptUrl.href)
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.log('SW failed:', err));
        }
      };

      useEffect(() => {
        if (!isDevelopment) registerServiceWorker();

        const initLoad = async () => {
          let hasCache = false;
          try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
              const { data: cachedData, timestamp } = JSON.parse(cached);
              setData(cachedData);
              setLastUpdated(new Date(timestamp));
              hasCache = true;
              setIsLoading(false);
            }
          } catch (e) {
            console.error('cache load failed', e);
            localStorage.removeItem(CACHE_KEY);
          }

          try {
            const result = await googleScript.getServerData();
            if (result?.error) throw new Error(result.message);
            updateStateAndCache(result);
            setError(null);
          } catch (e) {
            const msg = e.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            if (!hasCache) setError(msg);
            else console.error('Background fetch failed:', msg);
          } finally {
            setIsLoading(false);
          }
        };

        initLoad();
      }, []);

      const handleMutation = async (mutationPromise) => {
        setIsLoading(true);
        const original = data;
        try {
          const newData = await mutationPromise;
          if (newData?.error) throw new Error(newData.message);
          updateStateAndCache(newData);
          setError(null);
        } catch (e) {
          setError('ë°ì´í„° ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          setData(original);
        } finally {
          setIsLoading(false);
        }
      };

      const handleAddAnnouncement = async (text) => {
        setIsLoading(true);
        const original = data;
        try {
          const newAnnouncements = await googleScript.addAnnouncement(text);
          const updated = { ...data, announcements: newAnnouncements };
          updateStateAndCache(updated);
          setError(null);
        } catch (e) {
          setError('ê³µì§€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          setData(original);
        } finally {
          setIsLoading(false);
        }
      };

      const renderView = () => {
        if (!data) return null;
        switch (view) {
          case 'announcement':
            return <AnnouncementsView announcements={data.announcements} onAdd={handleAddAnnouncement} isLoading={isLoading} />;
          case 'schedule':
            return <ScheduleInfoView teachers={data.teachers} />;
          case 'bus':
            return <BusView data={data} onUpdate={handleMutation} isLoading={isLoading} />;
          case 'room':
            return (
              <RoomsView
                roomData={data.roomData}
                teachers={data.teachers}
                students={data.students}
                onUpdate={handleMutation}
                isLoading={isLoading}
              />
            );
          case 'meal':
            return <MealView data={data} onUpdate={handleMutation} isLoading={isLoading} />;
          case 'activity':
            return <ActivityMissionView activities={data.activities} missions={data.missions} data={data} onUpdate={handleMutation} isLoading={isLoading} />;
          case 'students':
            return <AllStudentsView students={data.students} busData={data.busData} activities={data.activities} />;
          default:
            return <AnnouncementsView announcements={data.announcements} onAdd={handleAddAnnouncement} isLoading={isLoading} />;
        }
      };

      if (isLoading && !data) return <LoadingSpinner message="ìˆ˜í•™ì—¬í–‰ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." />;

      if (error && !data) {
        return (
          <div className="p-8 text-center text-red-600 bg-red-50">
            <h2 className="text-xl font-bold mb-4">ì˜¤ë¥˜ ë°œìƒ</h2>
            <p>{error}</p>
            <p className="mt-4 text-sm text-gray-500">ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</p>
          </div>
        );
      }

      const navItems = [
        { id: 'announcement', icon: <MegaphoneIcon />, label: 'ê³µì§€' },
        { id: 'schedule', icon: <ScheduleIcon />, label: 'ì¼ì •/ì •ë³´' },
        { id: 'bus', icon: <BusIcon />, label: 'ë²„ìŠ¤' },
        { id: 'room', icon: <KeyIcon />, label: 'ìˆ™ì†Œ' },
        { id: 'meal', icon: <FoodIcon />, label: 'ì‹ì‚¬' },
        { id: 'activity', icon: <StarIcon />, label: 'ë¯¸ì…˜/í™œë™' },
        { id: 'students', icon: <UsersIcon />, label: 'ì „ì²´í•™ìƒ' },
      ];

      return (
        <div className="max-w-lg mx-auto bg-white shadow-2xl flex flex-col h-screen-safe">
          {error && data && (
            <div className="bg-yellow-500 text-white text-center p-2 text-sm z-20 shrink-0">
              ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¶ˆì•ˆì •. ì˜¤í”„ë¼ì¸ ë°ì´í„° í‘œì‹œ ì¤‘.
              {lastUpdated && ` (ë§ˆì§€ë§‰ ë™ê¸°í™”: ${lastUpdated.toLocaleTimeString('ko-KR')})`}
            </div>
          )}

          <header className="text-center p-4 border-b shrink-0">
            <h1 className="text-2xl font-bold text-blue-600">ì§„í•´ë™ì¼ê³  ìˆ˜í•™ì—¬í–‰ ì¢…í•© ì‹œìŠ¤í…œ</h1>
          </header>

          <main className="flex-grow overflow-y-auto bg-gray-50">
            {renderView()}
          </main>

          <footer className="border-t sticky bottom-0 bg-white shrink-0">
            <nav className="flex justify-around">
              {navItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => setView(item.id)}
                  className={`flex flex-col items-center justify-center pt-2 pb-1 w-full transition-colors duration-200 ${
                    view === item.id ? 'text-blue-600' : 'text-gray-500 hover:text-blue-500'
                  }`}
                >
                  {React.cloneElement(item.icon, { className: 'w-7 h-7' })}
                  <span className="text-xs mt-1">{item.label}</span>
                </button>
              ))}
            </nav>
          </footer>
        </div>
      );
    };

    // =========================
    // 8) Render
    // =========================
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <StrictMode>
        <App />
      </StrictMode>
    );
  </script>
</body>
</html>
